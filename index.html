
<!DOCTYPE html>
<html>
<head>
    <title>IPTV Player</title>
    <link href="https://vjs.zencdn.net/7.20.3/video-js.css" rel="stylesheet" />
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; background-color: #f0f0f0; margin: 0; padding: 20px; }
        .container { display: flex; width: 90%; max-width: 1200px; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); overflow: hidden; }
        .player-container { flex: 3; background-color: #000; display: flex; justify-content: center; align-items: center; min-height: 400px; position: relative; /* Added for loading indicator positioning */ }
        .video-js { width: 100%; height: 100%; }
        .channel-list-container { flex: 1; padding: 20px; border-left: 1px solid #eee; background-color: #f9f9f9; max-height: 80vh; overflow-y: auto; }
        .channel-list-container h2 { margin-top: 0; color: #333; font-size: 1.5em; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        #channel-search { width: calc(100% - 20px); padding: 8px 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        #channel-list { list-style: none; padding: 0; margin: 0; }
        #channel-list li { padding: 10px 5px; cursor: pointer; border-bottom: 1px dashed #eee; transition: background-color 0.2s; color: #555; font-size: 0.95em; }
        #channel-list li:last-child { border-bottom: none; }
        #channel-list li:hover { background-color: #e9e9e9; color: #000; }
        #channel-list li.active { background-color: #007bff; color: white; font-weight: bold; border-left: 5px solid #ffc107; padding-left: 15px; }

        /* Loading Indicator Styles */
        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            z-index: 10;
            display: none; /* Hidden by default */
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* M3U Lists Display Styles */
        #loaded-m3u-lists {
            margin-bottom: 20px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        #loaded-m3u-lists h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #666;
            font-size: 1em;
        }
        #loaded-m3u-lists ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #loaded-m3u-lists li {
            font-size: 0.85em;
            color: #888;
            word-break: break-all;
            margin-bottom: 5px;
        }

        /* Add M3U Section Styles */
        #add-m3u-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        #add-m3u-section h3 {
            margin-top: 0;
            margin-bottom: 5px;
            color: #333;
            font-size: 1em;
        }
        #new-m3u-url {
            width: calc(100% - 22px); /* Account for padding and border */
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 0.9em;
        }
        #add-m3u-button {
            padding: 10px 15px;
            background-color: #28a745; /* Green button */
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s;
        }
        #add-m3u-button:hover {
            background-color: #218838;
        }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { flex-direction: column; width: 95%; }
            .player-container { flex: auto; min-height: unset; width: 100%; }
            .channel-list-container { width: 100%; border-left: none; margin-top: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="player-container">
            <video id="my-video" class="video-js vjs-default-skin" controls preload="auto" width="640" height="360" data-setup='{}'>
                <p class="vjs-no-js">
                    To view this video please enable JavaScript, and consider upgrading to a
                    web browser that <a href="https://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>
                </p>
            </video>
            <div id="loading-indicator" class="loading-indicator"></div> <!-- Loading Indicator Added -->
        </div>
        <div class="channel-list-container">
            <h2>Canais</h2>
            <div id="loaded-m3u-lists">
                <h3>M3U Playlists Carregadas:</h3>
                <!-- M3U URLs will be inserted here by JavaScript -->
            </div>
            <div id="add-m3u-section">
                <h3>Adicionar Nova Playlist M3U:</h3>
                <input type="text" id="new-m3u-url" placeholder="Cole a URL M3U aqui">
                <button id="add-m3u-button">Adicionar Lista M3U</button>
            </div>
            <input type="text" id="channel-search" placeholder="Buscar canais...">
            <ul id="channel-list">
                
            </ul>
        </div>
    </div>
    <script src="https://vjs.zencdn.net/7.20.3/video.min.js"></script>
    <script>
        
        var player = videojs('my-video');
        var channelList = document.getElementById('channel-list');
        var channelSearch = document.getElementById('channel-search');
        var loadingIndicator = document.getElementById('loading-indicator');
        var loadedM3uListsDiv = document.getElementById('loaded-m3u-lists');
        var newM3uUrlInput = document.getElementById('new-m3u-url');
        var addM3uButton = document.getElementById('add-m3u-button');

        // Define the M3U URLs here to be accessible in JavaScript
        var initialM3uUrls = [
            """https://iptv-org.github.io/iptv/subdivisions/br-ba.m3u""",
            """https://iptv-org.github.io/iptv/countries/br.m3u"""
        ];
        var m3uUrls = []; // This will be populated dynamically as URLs are successfully loaded.

        // Function to show loading indicator
        function showLoading() {
            loadingIndicator.style.display = 'block';
        }

        // Function to hide loading indicator
        function hideLoading() {
            loadingIndicator.style.display = 'none';
        }

        // Event listeners for player state
        player.on('waiting', showLoading); // Show loading when player is waiting for data
        player.on('playing', hideLoading); // Hide loading when player starts playing
        // Modified error handler
        player.on('error', function() {
            hideLoading();
            alert('Erro ao carregar o canal. Por favor, tente outro canal.');
        });   // Hide loading and show alert if an error occurs

        // Function to load and play a channel
        function loadChannel(url, name) {
            showLoading(); // Show loading indicator immediately when a channel is selected
            player.src({
                src: url,
                type: 'application/x-mpegURL' // M3U8 format
            });
            player.load();
            player.play();
            document.title = 'IPTV Player - ' + name; // Update page title
        }

        // Function to render channels to the list
        function renderChannels(channelsToRender) {
            channelList.innerHTML = ''; // Clear existing list
            channelsToRender.forEach(function(channel) {
                var liElement = document.createElement('li');
                liElement.setAttribute('data-url', channel.url);
                liElement.textContent = channel.name;
                channelList.appendChild(liElement);
            });
        }

        // Initialize allChannels as an empty list (Step 1)
        var allChannels = [];

        // No initial call to renderChannels(allChannels) as it's empty (Step 2)

        // Add click event listeners to channel list items
        channelList.addEventListener('click', function(event) {
            var target = event.target;
            if (target.tagName === 'LI') {
                // Remove active class from previously active item
                var currentActive = document.querySelector('#channel-list li.active');
                if (currentActive) {
                    currentActive.classList.remove('active');
                }
                // Add active class to clicked item
                target.classList.add('active');

                var url = target.getAttribute('data-url');
                var name = target.textContent;
                loadChannel(url, name);
            }
        });

        // Search functionality
        channelSearch.addEventListener('input', function(event) {
            var searchTerm = event.target.value.toLowerCase();
            var filteredChannels = allChannels.filter(function(channel) {
                return channel.name.toLowerCase().includes(searchTerm);
            });
            renderChannels(filteredChannels);
        });

        // Function to parse M3U content (simplified for browser-side)
        function parseM3U(m3uContent) {
            var newChannels = [];
            var lines = m3uContent.split(/?
/);
            var name = '';
            for (var i = 0; i < lines.length; i++) {
                var line = lines[i].trim();
                if (line.startsWith('#EXTINF')) {
                    var match = line.match(/,(.*)$/);
                    if (match && match[1]) {
                        name = match[1].trim();
                    }
                } else if (line.startsWith('http')) {
                    if (name && line) {
                        newChannels.push({
                            name: name,
                            url: line
                        });
                        name = ''; // Reset name for next channel
                    }
                }
            }
            return newChannels;
        }

        // Populate loaded M3U lists section (Step 7 - update moved to processAndAddM3u and loadInitialM3uLists)
        function updateLoadedM3uLists() {
            var ulElement = loadedM3uListsDiv.querySelector('ul');
            if (!ulElement) {
                ulElement = document.createElement('ul');
                loadedM3uListsDiv.appendChild(ulElement);
            }
            ulElement.innerHTML = ''; // Clear existing list
            m3uUrls.forEach(function(url) {
                var liElement = document.createElement('li');
                var aElement = document.createElement('a');
                aElement.href = url;
                aElement.textContent = url;
                aElement.target = '_blank'; // Open link in a new tab
                liElement.appendChild(aElement);
                ulElement.appendChild(liElement);
            });
        }

        // Encapsulate M3U loading logic into a new async function (Step 3)
        async function processAndAddM3u(url) {
            if (m3uUrls.includes(url)) {
                console.log('URL already loaded:', url);
                return; // Skip if URL is already loaded
            }
            try {
                var response = await fetch(url);
                if (!response.ok) {
                    throw new Error('HTTP error! status: ' + response.status);
                }
                var m3uText = await response.text();
                var newChannels = parseM3U(m3uText);
                allChannels = allChannels.concat(newChannels); // Add new channels to the main list
                renderChannels(allChannels); // Re-render the full list including new channels

                m3uUrls.push(url); // Add new URL to the displayed list
                updateLoadedM3uLists(); // Refresh the displayed M3U URLs
                // alert('Playlist M3U adicionada com sucesso!'); // Removed for initial load
            } catch (error) {
                console.error('Erro ao carregar ou analisar a playlist M3U:', error);
                alert('Erro ao carregar a playlist M3U do URL: ' + url + '. Verifique a URL e a conectividade.');
            }
        }

        // Handle adding new M3U list (Step 4)
        addM3uButton.addEventListener('click', async function() {
            var newM3uUrl = newM3uUrlInput.value.trim();
            if (newM3uUrl) {
                await processAndAddM3u(newM3uUrl);
                newM3uUrlInput.value = ''; // Clear input field
                alert('Playlist M3U adicionada com sucesso!'); // Alert after successful dynamic add
            } else {
                alert('Por favor, insira uma URL M3U vÃ¡lida.');
            }
        });

        // Create and call function to load initial M3U lists (Step 5 & 6)
        async function loadInitialM3uLists() {
            for (const url of initialM3uUrls) {
                await processAndAddM3u(url);
            }
        }
        loadInitialM3uLists(); // Call on page load

        // Keyboard navigation functionality (New code for this step)
        document.addEventListener('keydown', function(event) {
            // Do not interfere with search input
            if (document.activeElement === channelSearch) {
                return;
            }

            var visibleChannels = Array.from(channelList.children).filter(li => li.style.display !== 'none');
            if (visibleChannels.length === 0) {
                return;
            }

            var currentActive = document.querySelector('#channel-list li.active');
            var currentIndex = -1;
            if (currentActive) {
                currentIndex = visibleChannels.indexOf(currentActive);
            }

            if (event.key === 'ArrowDown') {
                event.preventDefault(); // Prevent page scrolling
                var nextIndex = (currentIndex + 1) % visibleChannels.length;
                var nextChannel = visibleChannels[nextIndex];

                if (currentActive) {
                    currentActive.classList.remove('active');
                }
                nextChannel.classList.add('active');
                nextChannel.scrollIntoView({
                    behavior: 'smooth',
                    block: 'nearest'
                });
            } else if (event.key === 'ArrowUp') {
                event.preventDefault(); // Prevent page scrolling
                var prevIndex = (currentIndex - 1 + visibleChannels.length) % visibleChannels.length;
                var prevChannel = visibleChannels[prevIndex];

                if (currentActive) {
                    currentActive.classList.remove('active');
                }
                prevChannel.classList.add('active');
                prevChannel.scrollIntoView({
                    behavior: 'smooth',
                    block: 'nearest'
                });
            } else if (event.key === 'Enter') {
                if (currentActive) {
                    event.preventDefault(); // Prevent default Enter key behavior (e.g., form submission)
                    currentActive.click(); // Simulate click on active channel
                }
            }
        });
    
    </script>
</body>
</html>
